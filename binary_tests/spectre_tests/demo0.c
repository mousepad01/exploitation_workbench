#include <stdio.h>
#include <stdlib.h>
#include <x86intrin.h>
#include <fcntl.h>
#include <unistd.h>

#define V_STEPS 256
#define V_DIST (512)
#define V_LEN (V_DIST * V_STEPS)

#define TEST_CNT 1000

#define CACHE_HIT_THRESH 80

#define CHOICE 100
#define ALTCHOICE 200

char unused0[4096];
char accessed[V_LEN];
char unused1[4096];

u_int64_t results[V_STEPS];
int var = 123;

/* STATS-ONLY */
void save_stats()
{   

    int fd = open("e0_stats.bin", O_WRONLY | O_CREAT | O_TRUNC, S_IRWXG | S_IRWXU | S_IRWXO);

    u_int64_t test_cnt = TEST_CNT;

    write(fd, (char *)(&test_cnt), 8);
    write(fd, results, V_STEPS * sizeof(u_int64_t));

    close(fd);
}

void all()
{
    for(int i = 0; i < V_STEPS; i++)
        var &= accessed[i * V_DIST];
}

void f(size_t x)
{
    var = accessed[x * V_DIST];
}

void fct(int ok)
{   
    if(ok)
        f(CHOICE);
    else
        f(ALTCHOICE);
}

void check_access()
{   

    volatile char *addr;
    int j;
    register u_int64_t tstart, tend;

    u_int64_t ignored;

    for(int i = 0; i < V_STEPS; i++)
        results[i] = 0;

    for(int t = 0; t < TEST_CNT; t++){

        /* prepare */

        for(int i = 0; i < V_STEPS; i++)
            _mm_clflush(accessed + i * V_DIST);

        /* execute */

        fct(1);

        /* check */

        for(int i = 0; i < V_STEPS; i++){

            j = ((i * 167) + 13) & (V_STEPS - 1);
            addr = accessed + j * V_DIST;

            tstart = __rdtscp(&ignored);
            ignored = *addr;
            tend = __rdtscp(&ignored);

            if(tend - tstart < CACHE_HIT_THRESH)
                results[j] += 1;
        }
    }

    save_stats();
}

int main()
{   
    
    /* VERY IMPORTANT !!! */
    for (int i = 0; i < V_STEPS; i++)
        accessed[i * V_DIST] = 1;

    check_access();
}