#include <stdio.h>
#include <stdlib.h>
#include <x86intrin.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <string.h>

long (*gadget)(int * idx_ptr, char * accessed);
const char *transmit_space;

const char *gadget_contents = "\x48\x31\xC0\x8A\x07\x48\x01\xC6\x8A\x06\xC3";

/*
"xor rax, rax"
"mov al, [rdi]"
"add rsi, rax"
"mov al, [rsi]"
"ret"

rsi should contain transmit_space address
rdi should point to attacked memory
*/

void demo()
{   
    int idx = 5;
    char *accessed = "ABCDEFGH";

    printf("%lx\n", gadget(&idx, accessed));
}

void mkshared()
{
    void *addr = mmap(0x10000, 0x1000, PROT_READ | PROT_EXEC, 
                        MAP_SHARED | MAP_ANONYMOUS, NULL, NULL);

    printf("gadget addr: %lx\n", addr);

    gadget = (void (*)(int *, char *))addr;

    addr = mmap(0x20000, 0x1000, PROT_READ, 
                    MAP_SHARED | MAP_ANONYMOUS, NULL, NULL);

    printf("transmit buffer addr: %lx\n", addr);

    transmit_space = addr;
}

int main()
{   
    mkshared();
    demo();

    return 0;
}